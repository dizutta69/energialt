<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Cotizador Solar – Colombia (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#f7f7f7}
    #map{height:55vh;border-radius:8px;margin:.5rem 0}
    label,input,button{font-size:1rem;padding:.4rem .6rem;margin:.2rem 0}
    #searchBox{width:60%}
    button{cursor:pointer;background:#00704a;color:#fff;border:none;border-radius:4px}
    pre{background:#fff;padding:1rem;border-radius:4px;overflow:auto}
  </style>
</head>

<body>
  <h1>Cotizador Solar Rápido</h1>

  <!-- ===== BÚSQUEDA ===== -->
  <label>
    Dirección:
    <input id="searchBox" type="text" placeholder="Cra 15 # 120-30, Bogotá"/>
    <button onclick="buscaConBoton()">Buscar</button>
  </label>
  <br/>

  <!-- ===== MAPA ===== -->
  <div id="map"></div>

  <!-- ===== FACTURA ===== -->
  <label>Factura mensual (COP):
    <input id="bill" type="number" placeholder="200000"/>
  </label>
  <br/>

  <!-- ===== COORDENADAS ===== -->
  <label>Lat: <input id="latTxt" readonly/></label>
  <label>Lon: <input id="lonTxt" readonly/></label>
  <br/>

  <button onclick="cotizar()">Cotizar</button>

  <pre id="out">Resultado aparecerá aquí…</pre>

  <!-- ===== GOOGLE MAPS ===== -->
  <script>
    let map, marker, autocomplete, searchBox;

    function initMap(){
      const bogota = {lat:4.711, lng:-74.072};
      map = new google.maps.Map(document.getElementById('map'),{
        zoom: 12,
        center: bogota,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        position: bogota,
        map: map,
        draggable: true,
        title: 'Arrastra para ajustar'
      });

      // Cuadro de autocompletado
      searchBox = document.getElementById('searchBox');
      autocomplete = new google.maps.places.Autocomplete(searchBox, {
        fields: ['geometry', 'formatted_address'],
        types: ['address']
      });
      autocomplete.bindTo('bounds', map);

      // Evento cuando el usuario ELIGE del desplegable
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place.geometry){ return; }
        muestraLugar(place.geometry.location);
      });

      // Arrastrar marcador
      marker.addListener('dragend', ()=>{
        const pos = marker.getPosition();
        actualizaCoords(pos.lat(), pos.lng());
      });

      actualizaCoords(bogota.lat, bogota.lng);
    }

    // FUNCIÓN que llama el BOTÓN «Buscar»
    function buscaConBoton(){
      // Si el autocompletado ya tiene un lugar seleccionado, lo usamos
      const place = autocomplete.getPlace();
      if(place && place.geometry){
        muestraLugar(place.geometry.location);
        return;
      }
      // Si no, hacemos una búsqueda programada con PlacesService
      const service = new google.maps.places.PlacesService(map);
      service.textSearch({query: searchBox.value}, (results, status)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && results[0]){
          muestraLugar(results[0].geometry.location);
        }else{
          alert('Dirección no encontrada. Prueba otra forma o pega lat,lon');
        }
      });
    }

    function muestraLugar(latLng){
      map.setCenter(latLng);
      marker.setPosition(latLng);
      actualizaCoords(latLng.lat(), latLng.lng());
    }

    function actualizaCoords(lat, lon){
      document.getElementById('latTxt').value = lat.toFixed(5);
      document.getElementById('lonTxt').value = lon.toFixed(5);
    }

    /* ---------- COTIZAR ---------- */
    async function cotizar(){
      const lat = parseFloat(document.getElementById('latTxt').value);
      const lon = parseFloat(document.getElementById('lonTxt').value);
      const bill = parseFloat(document.getElementById('bill').value);
      if(!lat || !lon || !bill){ alert('Define ubicación y factura'); return; }

      document.getElementById('out').textContent = 'Calculando…';

      const resp = await fetch("https://api.github.com/repos/dizutta69/energialt/dispatches",{
        method:"POST",
        headers:{
          "Accept":"application/vnd.github+json",
          "Authorization":"token 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",
          "Content-Type":"application/json"
        },
        body:JSON.stringify({
          event_type:"quote",
          client_payload:{lat, lon, bill, currency:"COP"}
        })
      });
      if(!resp.ok){ alert("Error llamando backend"); return; }

      await new Promise(r=>setTimeout(r,32000));
      const issue = await fetch("https://api.github.com/repos/dizutta69/energialt/issues?sort=created&direction=desc&per_page=1")
                     .then(r=>r.json()).then(j=>j[0]);
      document.getElementById('out').textContent = issue.body;
    }
  </script>

  <!-- Carga de Google Maps con tu clave -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAxfYXhmjShvgyGH-3AVUQAyKNFxINjfqk&libraries=places&callback=initMap">
  </script>
</body>
</html>

