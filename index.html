<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Cotizador Solar Rápido</title>
  <style>body{font-family:system-ui;margin:2rem}</style>
</head>
<body>
  <h1>Cotizador Solar Rápido</h1>
  <label>Dirección: <input id="addr" placeholder="Av. Apoquindo 4800, Las Condes"></label><br>
  <label>Factura mensual (CLP): <input id="bill" type="number"></label><br>
  <button onclick="quote()">Cotizar</button>
  <pre id="out"></pre>

  <script>
  async function quote(){
    const addr = document.getElementById("addr").value;
    const bill = document.getElementById("bill").value;
    // Geocodificar gratis con Nominatim
    const geo = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addr)}`).then(r=>r.json());
    if(!geo.length){ alert("No encontré la dirección"); return; }
    const {lat,lon} = geo[0];

    // Disparar GitHub Action
    const res = await fetch("https://api.github.com/repos/TU_USUARIO/TU_REPO/dispatches",{
      method:"POST",
      headers:{
        "Accept":"application/vnd.github+json",
        "Authorization":"token TU_GITHUB_TOKEN_CLASSIC", // scope: repo
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        event_type:"quote",
        client_payload:{lat,lon,bill,currency:"CLP"}
      })
    });
    if(!res.ok){ alert("Error llamando backend"); return; }

    // Esperar ~30 s y leer el artefacto (simplificado: lo escribimos en una Issue)
    document.getElementById("out").textContent = "Calculando…";
    await new Promise(r=>setTimeout(r,35000));
    const issue = await fetch("https://api.github.com/repos/TU_USUARIO/TU_REPO/issues?sort=created&direction=desc&per_page=1")
                   .then(r=>r.json()).then(j=>j[0]);
    document.getElementById("out").textContent = issue.body;
  }
  </script>
</body>
</html>