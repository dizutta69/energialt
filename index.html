<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Cotizador Solar ‚Äì Colombia (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#f7f7f7}
    #map{height:55vh;border-radius:8px;margin:.5rem 0}
    label,input,button{font-size:1rem;padding:.4rem .6rem;margin:.2rem 0}
    #searchBox{width:60%}
    button{cursor:pointer;background:#00704a;color:#fff;border:none;border-radius:4px}
    pre{background:#fff;padding:1rem;border-radius:4px;overflow:auto}
    .energy-diagram {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      font-family: system-ui, sans-serif;
      text-align: center;
    }
    /* ---- Overlay texts on the image ---- */
    .energy-overlay {
      position: relative;
      display: inline-block;          /* shrink-wrap to image */
      margin: 1rem auto;
    }
    .energy-overlay img {
      max-width: 100%;
      height: auto;
    }
    .overlay-text {
      position: absolute;
      font-weight: 700;
      font-size: 1.1rem;
      color: #fff;
      text-shadow: 0 0 4px #000;
      padding: 2px 6px;
      border-radius: 4px;
      background: rgba(0,0,0,.35);
    }
    /* quick tuning knobs */
    #txtSolar { top: 15%;  left: 10%; }
    #txtGrid  { top: 15%;  right: 10%; }
    #txtHome  { bottom: 8%; left: 50%; transform: translateX(-50%);}
    
    .bar-wrap {
      display: flex;
      align-items: center;
      margin: .6rem 0;
    }
    .bar {
      height: 24px;
      border-radius: 4px;
      margin-right: .8rem;
      transition: width .4s ease;
    }
    .solar { background: #2ecc71; }
    .grid  { background: #e74c3c; }
    .home  { background: #f39c12; }
    .label {
      font-weight: 600;
      font-size: .95rem;
      color: #333;
    }
    .legend {
      margin-top: .8rem;
      font-size: .8rem;
      color: #666;
    }
  </style>
</head>

<body>
  <h1>Cotizador Solar R√°pido</h1>

  <label>
    Direcci√≥n:
    <input id="searchBox" type="text" placeholder="Cra 15 # 120-30, Bogot√°"/>
    <button onclick="buscaConBoton()">Buscar</button>
  </label>
  <br/>

  <div id="map"></div>

  <label>Factura mensual (COP):
    <input id="bill" type="number" placeholder="200000"/>
  </label>
  <br/>

  <label>Lat: <input id="latTxt" readonly/></label>
  <label>Lon: <input id="lonTxt" readonly/></label>
  <br/>

  <button onclick="cotizar()">Cotizar</button>

  <!-- Imagen de diagrama de energ√≠a -->
  <!<img id="energyDiagram" src="solar.png" alt="Energy Diagram" style="max-width:100%; height:auto; margin:1rem auto; display:block;">

  <!-- Diagrama de barras -->

  <!-- OLD -->
  <!-- <div id="out" class="energy-diagram"> ‚Ä¶ </div> -->

  <!-- NEW -->
  <div id="out" class="energy-diagram">
    <div class="energy-overlay">
      <img src="solar.png" alt="Energy Diagram">
      <!-- texts will be written here -->
      <span id="txtSolar" class="overlay-text">0 kWh/mes</span>
      <span id="txtGrid"  class="overlay-text">0 kWh/mes</span>
      <span id="txtHome"  class="overlay-text">0 kWh/mes</span>
    </div>

    <!-- optional: keep the bars if you like them -->
    <div class="bar-wrap">
      <div class="bar solar" id="barSolar"></div>
      <span class="label" id="labSolar">0 kWh/d√≠a</span>
    </div>
    <div class="bar-wrap">
      <div class="bar grid" id="barGrid"></div>
      <span class="label" id="labGrid">0 kWh/d√≠a</span>
    </div>
    <div class="bar-wrap">
      <div class="bar home" id="barHome"></div>
      <span class="label" id="labHome">0 kWh/d√≠a</span>
    </div>
    <p class="legend">üí° Solar ¬∑ üî¥ Red ¬∑ üü† Hogar</p>
  </div>

  <!-- Google Maps -->
  <script>
    let map, marker, autocomplete;

    function initMap(){
      const bogota = {lat:4.711, lng:-74.072};
      map = new google.maps.Map(document.getElementById('map'),{
        zoom: 12,
        center: bogota,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        position: bogota,
        map: map,
        draggable: true,
        title: 'Arrastra para ajustar'
      });

      const input = document.getElementById('searchBox');
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['geometry', 'formatted_address'],
        types: ['address']
      });
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place.geometry){ return; }
        muestraLugar(place.geometry.location);
      });

      marker.addListener('dragend', ()=>{
        const pos = marker.getPosition();
        actualizaCoords(pos.lat(), pos.lng());
      });

      actualizaCoords(bogota.lat, bogota.lng);
    }

    function buscaConBoton(){
      const place = autocomplete.getPlace && autocomplete.getPlace();
      if(place && place.geometry){
        muestraLugar(place.geometry.location);
        return;
      }
      const service = new google.maps.places.PlacesService(map);
      service.textSearch({query: document.getElementById('searchBox').value}, (results, status)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && results[0]){
          muestraLugar(results[0].geometry.location);
        }else{
          alert('Direcci√≥n no encontrada. Prueba otra forma o pega lat,lon');
        }
      });
    }

    function muestraLugar(latLng){
      map.setCenter(latLng);
      marker.setPosition(latLng);
      actualizaCoords(latLng.lat(), latLng.lng());
    }

    function actualizaCoords(lat, lng){
      document.getElementById('latTxt').value = lat.toFixed(5);
      document.getElementById('lonTxt').value = lng.toFixed(5);
    }

    /* ---------- C√ÅLCULO INSTANT√ÅNEO ---------- */
    async function cotizar(){
      const lat = parseFloat(document.getElementById('latTxt').value);
      const lon = parseFloat(document.getElementById('lonTxt').value);
      const bill = parseFloat(document.getElementById('bill').value);
      if(!lat || !lon || !bill){ alert('Define ubicaci√≥n y factura'); return; }

      document.getElementById('out').textContent = 'Calculando‚Ä¶';

      /* ====== CONSTANTS ====== */
      const PRICE_KWH       = 890;           // COP / kWh
      const USD_COP         = 4000;          // today
      const USD_W_INSTALLED = 0.9;           // USD / Wp
      const PANEL_W         = 450;           // Wp per panel
      const LOSS            = 0.8;           // DC/AC losses
      const TARGET          = 0.7;           // 70 % savings

      /* 1) Monthly kWh from bill */
      const kwhMonth = bill / PRICE_KWH;
      const kwh70    = kwhMonth * TARGET;

      /* 2) Specific yield (kWh/kWp/year) via PVWatts client-side */
      let specific;
      try{
        const pvw = await fetch(
          `https://developer.nrel.gov/api/pvwatts/v8.json?api_key=DEMO_KEY&lat=${lat}&lon=${lon}&system_capacity=1&azimuth=180&tilt=${Math.abs(lat)}&array_type=1&losses=14&timeframe=monthly`
        ).then(r => r.json());
        specific = pvw.outputs.ac_monthly.reduce((a,b)=>a+b,0) / 1.0; // kWh/kWp/year
      }catch{
        specific = 1350; // Bogot√° fallback
      }

      /* 3) kWp required */
      const kwp     = (kwh70 * 12) / specific;
      const panels  = Math.ceil(kwp / (PANEL_W/1000));
      const kwpReal = panels * (PANEL_W/1000);

      /* 4) Price */
      const priceUsd = kwpReal * 1000 * USD_W_INSTALLED;
      const priceCop = priceUsd * USD_COP;

      /* 5) Simple pay-back */
      const ahorroAnualCop = bill * 12 * TARGET;
      const payback = priceCop / ahorroAnualCop;

      /* 6) Build pretty output */
      const out =
        `üí° Consumo mensual: ${kwhMonth.toLocaleString()} kWh\n` +
        `‚òÄÔ∏è  Objetivo solar (70 %): ${kwh70.toLocaleString()} kWh\n` +
        `üîß Potencia de paneles: ${kwpReal.toFixed(2)} kWp  (${panels} paneles de ${PANEL_W} W)\n` +
        `üí∞ Precio aproximado: COP ${priceCop.toLocaleString()}\n` +
        `‚è±Ô∏è  Pay-back simple: ${payback.toFixed(1)} a√±os`;

      document.getElementById('out').textContent = out;

      /* 7) Update image text */
      /* 7) Escribir valores ENCIMA de la imagen */
      const monthlySolar = (kwh70 * 12) / specific;   // kWh/mes producidos
      const monthlyGrid  = kwhMonth - kwh70;          // kWh/mes comprados
      const monthlyHome  = kwhMonth;                  // kWh/mes consumidos

      document.getElementById('txtSolar').textContent = monthlySolar.toLocaleString() + ' kWh/mes';
      document.getElementById('txtGrid').textContent  = monthlyGrid.toLocaleString()  + ' kWh/mes';
      document.getElementById('txtHome').textContent  = monthlyHome.toLocaleString()  + ' kWh/mes';
      
      
      const dailySolar = (kwh70 * 12) / specific / 365;
      const dailyGrid  = (kwhMonth * 12) / 365 - dailySolar;
      const dailyHome  = (kwhMonth * 12) / 365;
      const maxBar     = Math.max(dailySolar, dailyGrid, dailyHome, 1);

      document.getElementById('barSolar').style.width = `${(dailySolar / maxBar * 70).toFixed(0)}%`;
      document.getElementById('labSolar').textContent = `${dailySolar.toFixed(2)} kWh/d√≠a`;
      document.getElementById('barGrid').style.width  = `${(dailyGrid  / maxBar * 70).toFixed(0)}%`;
      document.getElementById('labGrid').textContent  = `${dailyGrid.toFixed(2)}  kWh/d√≠a`;
      document.getElementById('barHome').style.width  = `${(dailyHome  / maxBar * 70).toFixed(0)}%`;
      document.getElementById('labHome').textContent  = `${dailyHome.toFixed(2)}  kWh/d√≠a`;

      
      /* 8) (Optional) keep creating the Issue for record */
      fetch("https://api.github.com/repos/dizutta69/energialt/dispatches",{
        method:"POST",
        headers:{
          "Accept":"application/vnd.github+json",
          "Authorization":"token {{ secrets.GH_TOKEN }}",
          "Content-Type":"application/json"
        },
        body:JSON.stringify({event_type:"quote",client_payload:{lat,lon,bill,currency:"COP"}})
      });
    }
  </script>

  <!-- Carga de Google Maps con tu clave real (sin secretos) -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_API_KEY_AQUI&libraries=places&callback=initMap">
  </script>
</body>
</html>



