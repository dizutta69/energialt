<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Cotizador Solar ‚Äì Colombia (Google Maps)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    body{font-family:system-ui;margin:0;padding:1rem;background:#f7f7f7}
    #map{height:55vh;border-radius:8px;margin:.5rem 0}
    label,input,button{font-size:1rem;padding:.4rem .6rem;margin:.2rem 0}
    #searchBox{width:60%}
    button{cursor:pointer;background:#00704a;color:#fff;border:none;border-radius:4px}
    pre{background:#fff;padding:1rem;border-radius:4px;overflow:auto}
    .energy-diagram {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      font-family: system-ui, sans-serif;
      text-align: center;
      margin-top: 1rem;
    }
    /* ---- Overlay texts on the image ---- */
    .energy-overlay {
      position: relative;
      display: inline-block;          /* shrink-wrap to image */
      margin: 1rem auto;
    }
    .energy-overlay img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .overlay-text {
      position: absolute;
      font-weight: 700;
      font-size: 1.1rem;   /* M√°s peque√±o que antes */
      color: #fff;
      text-shadow: 0 0 5px #000;
      padding: 3px 8px;
      border-radius: 4px;
      background: rgba(0,0,0,.45);
      text-align: center;
      min-width: 120px; /* Para que todos tengan el mismo ancho */
    }

    /* NUEVAS POSICIONES para solar.png */
    #txtSolar { 
      bottom: 10%;    /* Inferior izquierda - Paneles */
      left: 5%; 
      transform: translateX(0);
    }
    #txtGrid  { 
      bottom: 10%;    /* Inferior derecha - Red */
      right: 5%; 
      transform: translateX(0);
    }
    #txtHome  { 
      top: 15%;       /* Superior centrada - Hogar */
      left: 50%; 
      transform: translateX(-50%);
    }

    /* ESTILOS PARA LA NUEVA IMAGEN FACTURA */
    .factura-overlay {
      position: relative;
      display: inline-block;
      margin: 1rem auto;
    }
    .factura-overlay img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .factura-text {
      position: absolute;
      font-weight: 700;
      font-size: 1.2rem;
      text-shadow: 0 0 5px #000;
      padding: 5px 10px;
      border-radius: 4px;
      background: transparent;
      text-align: center;
      min-width: 140px;
    }
    
    /* Valor anterior - Rojo - Izquierda 30% - Abajo 30% */
    #txtFacturaAntigua {
      color: #ff6b6b; /* Rojo */
      bottom: 30%;
      left: 30%;
      transform: translateX(-50%);
    }
    
    /* Valor nuevo - Verde - Derecha 30% - Arriba 50% */
    #txtFacturaNueva {
      color: #51cf66; /* Verde */
      top: 50%;
      right: 30%;
      transform: translateX(50%);
    }
   
    .bar-wrap {
      display: flex;
      align-items: center;
      margin: .6rem 0;
    }
    .bar {
      height: 24px;
      border-radius: 4px;
      margin-right: .8rem;
      transition: width .4s ease;
    }
    .solar { background: #2ecc71; }
    .grid  { background: #e74c3c; }
    .home  { background: #f39c12; }
    .label {
      font-weight: 600;
      font-size: .95rem;
      color: #333;
    }
    .legend {
      margin-top: .8rem;
      font-size: .8rem;
      color: #666;
    }
    #textOutput {
      white-space: pre-line;
      background: #fff;
      padding: 1rem;
      border-radius: 4px;
      margin-top: 1rem;
      border: 1px solid #ddd;
    }
    .calculando {
      text-align: center;
      padding: 2rem;
      font-size: 1.2rem;
      color: #666;
    }

    /* NUEVOS ESTILOS PARA LA GR√ÅFICA DE L√çNEA */
    .cashflow-chart {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 1rem;
      margin-top: 1rem;
      font-family: system-ui, sans-serif;
    }
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
    .chart-canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    .chart-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 1rem;
      font-size: 0.8rem;
      color: #666;
    }
    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 1rem;
      font-size: 0.8rem;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .legend-color {
      width: 15px;
      height: 3px;
      border-radius: 3px;
    }
  </style>
</head>

<body>
  <h1>Cotizador Solar R√°pido</h1>

  <label>
    Direcci√≥n:
    <input id="searchBox" type="text" placeholder="Cra 15 # 120-30, Bogot√°"/>
    <button onclick="buscaConBoton()">Buscar</button>
  </label>
  <br/>

  <div id="map"></div>

  <label>Factura mensual (COP):
    <input id="bill" type="number" placeholder="200000"/>
  </label>
  <br/>

  <label>Lat: <input id="latTxt" readonly/></label>
  <label>Lon: <input id="lonTxt" readonly/></label>
  <br/>

  <button onclick="cotizar()">Cotizar</button>

<!-- Aqu√≠ se mostrar√° el texto de resultados -->
<div id="textOutput"></div>

<!-- Diagrama con imagen + textos overlay - SIEMPRE VISIBLE -->
<div id="diagramContainer" class="energy-diagram">
  <div class="calculando" id="calculandoText" style="display: none;">Calculando...</div>
  
  <div id="diagramContent">
    <!-- Primera imagen: solar.png -->
    <div class="energy-overlay">
      <img src="solar.png" alt="Energy Diagram">
      <span id="txtSolar" class="overlay-text">0 kWh/mes</span>
      <span id="txtGrid"  class="overlay-text">0 kWh/mes</span>
      <span id="txtHome"  class="overlay-text">0 kWh/mes</span>
    </div>

    <!-- Segunda imagen: factura.png -->
    <div class="factura-overlay">
      <img src="factura.png" alt="Factura Comparaci√≥n">
      <span id="txtFacturaAntigua" class="factura-text">$0 COP</span>
      <span id="txtFacturaNueva" class="factura-text">$0 COP</span>
    </div>

    <!-- optional: keep the bars if you like them -->
    <div class="bar-wrap">
      <div class="bar solar" id="barSolar"></div>
      <span class="label" id="labSolar">0 kWh/d√≠a</span>
    </div>
    <div class="bar-wrap">
      <div class="bar grid" id="barGrid"></div>
      <span class="label" id="labGrid">0 kWh/d√≠a</span>
    </div>
    <div class="bar-wrap">
      <div class="bar home" id="barHome"></div>
      <span class="label" id="labHome">0 kWh/d√≠a</span>
    </div>
    <p class="legend">üí° Solar ¬∑ üî¥ Red ¬∑ üü† Hogar</p>
  </div>
</div>

<!-- NUEVA GR√ÅFICA DE L√çNEA DE FLUJO DE CAJA -->
<div id="cashflowChart" class="cashflow-chart" style="display: none;">
  <h3>Flujo de Caja Acumulado (10 A√±os)</h3>
  <div class="chart-container">
    <canvas id="lineChart" class="chart-canvas"></canvas>
  </div>
  <div class="chart-labels">
    <span>Inversi√≥n</span>
    <span>A√±o 2</span>
    <span>A√±o 4</span>
    <span>A√±o 6</span>
    <span>A√±o 8</span>
    <span>A√±o 10</span>
  </div>
  <div class="chart-legend">
    <div class="legend-item">
      <div class="legend-color" style="background: #00704a;"></div>
      <span>Flujo de Caja</span>
    </div>
    <div class="legend-item">
      <div class="legend-color" style="background: #f39c12;"></div>
      <span>Punto de Equilibrio</span>
    </div>
  </div>
  <div id="chartSummary" style="margin-top: 1rem; text-align: center; font-size: 0.9rem;"></div>
</div>

  <!-- Google Maps -->
  <script>
    let map, marker, autocomplete;

    function initMap(){
      const bogota = {lat:4.711, lng:-74.072};
      map = new google.maps.Map(document.getElementById('map'),{
        zoom: 12,
        center: bogota,
        mapTypeControl: false,
        streetViewControl: false,
        fullscreenControl: false
      });

      marker = new google.maps.Marker({
        position: bogota,
        map: map,
        draggable: true,
        title: 'Arrastra para ajustar'
      });

      const input = document.getElementById('searchBox');
      autocomplete = new google.maps.places.Autocomplete(input, {
        fields: ['geometry', 'formatted_address'],
        types: ['address']
      });
      autocomplete.bindTo('bounds', map);
      autocomplete.addListener('place_changed', ()=>{
        const place = autocomplete.getPlace();
        if(!place.geometry){ return; }
        muestraLugar(place.geometry.location);
      });

      marker.addListener('dragend', ()=>{
        const pos = marker.getPosition();
        actualizaCoords(pos.lat(), pos.lng());
      });

      actualizaCoords(bogota.lat, bogota.lng);
    }

    function buscaConBoton(){
      const place = autocomplete.getPlace && autocomplete.getPlace();
      if(place && place.geometry){
        muestraLugar(place.geometry.location);
        return;
      }
      const service = new google.maps.places.PlacesService(map);
      service.textSearch({query: document.getElementById('searchBox').value}, (results, status)=>{
        if(status === google.maps.places.PlacesServiceStatus.OK && results[0]){
          muestraLugar(results[0].geometry.location);
        }else{
          alert('Direcci√≥n no encontrada. Prueba otra forma o pega lat,lon');
        }
      });
    }

    function muestraLugar(latLng){
      map.setCenter(latLng);
      marker.setPosition(latLng);
      actualizaCoords(latLng.lat(), latLng.lng());
    }

    function actualizaCoords(lat, lng){
      document.getElementById('latTxt').value = lat.toFixed(5);
      document.getElementById('lonTxt').value = lng.toFixed(5);
    }

    /* FUNCI√ìN PARA CREAR LA GR√ÅFICA DE L√çNEA */
    function crearGraficaLinea(inversion, ahorroMensual, payback) {
      const canvas = document.getElementById('lineChart');
      const ctx = canvas.getContext('2d');
      const chartSummary = document.getElementById('chartSummary');

      // CONFIGURACI√ìN RESPONSIVE
      const container = canvas.parentElement;
      const rect = container.getBoundingClientRect();
      
      // Usar dimensiones CSS para el canvas
      canvas.width = rect.width;
      canvas.height = rect.height;
      
      // Limpiar canvas primero
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      const a√±os = 10;
      const ahorroAnual = ahorroMensual * 12;
      const breakEvenYear = Math.ceil(payback);
      
      // Calcular flujo de caja acumulado por a√±o
      const flujoCaja = [];
      let acumulado = -inversion;
      
      for (let a√±o = 0; a√±o <= a√±os; a√±o++) {
        if (a√±o === 0) {
          flujoCaja.push(acumulado);
        } else {
          acumulado += ahorroAnual;
          flujoCaja.push(acumulado);
        }
      }
      
      // Configurar dimensiones de la gr√°fica
      const padding = 40;
      const width = canvas.width - padding * 2;
      const height = canvas.height - padding * 2;
      
      // Encontrar m√°ximo y m√≠nimo para escalar
      const maxVal = Math.max(...flujoCaja);
      const minVal = Math.min(...flujoCaja);
      const range = maxVal - minVal;
      
      // Funci√≥n para mapear valores a coordenadas
      const x = (a√±o) => padding + (a√±o / a√±os) * width;
      const y = (valor) => {
        if (range === 0) return padding + height / 2;
        const normalized = (valor - minVal) / range;
        return padding + height - (normalized * height);
      };
      
      // Dibujar ejes
      ctx.strokeStyle = '#ccc';
      ctx.lineWidth = 1;
      ctx.beginPath();
      // Eje X
      ctx.moveTo(padding, padding + height);
      ctx.lineTo(padding + width, padding + height);
      // Eje Y
      ctx.moveTo(padding, padding);
      ctx.lineTo(padding, padding + height);
      ctx.stroke();
      
      // Dibujar l√≠nea de cero
      ctx.strokeStyle = '#999';
      ctx.setLineDash([5, 3]);
      ctx.beginPath();
      const zeroY = y(0);
      ctx.moveTo(padding, zeroY);
      ctx.lineTo(padding + width, zeroY);
      ctx.stroke();
      ctx.setLineDash([]);
      
      // Dibujar l√≠nea de flujo de caja
      ctx.strokeStyle = '#00704a';
      ctx.lineWidth = 3;
      ctx.beginPath();
      
      for (let a√±o = 0; a√±o <= a√±os; a√±o++) {
        if (a√±o === 0) {
          ctx.moveTo(x(a√±o), y(flujoCaja[a√±o]));
        } else {
          ctx.lineTo(x(a√±o), y(flujoCaja[a√±o]));
        }
      }
      ctx.stroke();
      
      // Dibujar puntos en cada a√±o
      for (let a√±o = 0; a√±o <= a√±os; a√±o++) {
        const pointX = x(a√±o);
        const pointY = y(flujoCaja[a√±o]);
        
        // Punto de equilibrio especial
        if (a√±o === breakEvenYear && flujoCaja[a√±o] >= 0) {
          ctx.fillStyle = '#f39c12';
          ctx.strokeStyle = '#fff';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(pointX, pointY, 6, 0, 2 * Math.PI);
          ctx.fill();
          ctx.stroke();
        } else {
          ctx.fillStyle = a√±o === 0 ? '#e74c3c' : '#00704a';
          ctx.beginPath();
          ctx.arc(pointX, pointY, 4, 0, 2 * Math.PI);
          ctx.fill();
        }
        
        // Etiquetas de valores
        ctx.fillStyle = '#333';
        ctx.font = '10px system-ui';
        ctx.textAlign = 'center';
        
        // Solo mostrar algunos valores para no saturar
        if (a√±o === 0 || a√±o === breakEvenYear || a√±o === a√±os || a√±o % 2 === 0) {
          const labelY = pointY - 15;
          ctx.fillText(`$${(flujoCaja[a√±o]/1000000).toFixed(1)}M`, pointX, labelY);
        }
      }
      
      // Etiquetas de ejes
      ctx.fillStyle = '#666';
      ctx.font = '12px system-ui';
      ctx.textAlign = 'center';
      ctx.fillText('A√±os', canvas.width / 2, canvas.height - 10);
      
      ctx.save();
      ctx.translate(10, canvas.height / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillText('Flujo de Caja (COP)', 0, 0);
      ctx.restore();
      
      // Resumen con validaci√≥n
      const gananciaTotal = flujoCaja[a√±os];
      const retornoTotal = inversion > 0 ? ((gananciaTotal / inversion) * 100) : 0;
      
      chartSummary.innerHTML = `
        <div><strong>Punto de equilibrio:</strong> A√±o ${breakEvenYear} ($${(flujoCaja[breakEvenYear] || 0).toLocaleString()} COP)</div>
        <div><strong>Ganancia acumulada a 10 a√±os:</strong> $${gananciaTotal.toLocaleString()} COP</div>
        <div><strong>Retorno total:</strong> ${retornoTotal.toFixed(0)}%</div>
      `;
      
      // Mostrar la gr√°fica
      document.getElementById('cashflowChart').style.display = 'block';
    }

    /* ---------- C√ÅLCULO INSTANT√ÅNEO ---------- */
    async function cotizar(){
      const lat = parseFloat(document.getElementById('latTxt').value);
      const lon = parseFloat(document.getElementById('lonTxt').value);
      const bill = parseFloat(document.getElementById('bill').value);
      
      // Validaci√≥n m√°s estricta
      if(isNaN(lat) || isNaN(lon) || isNaN(bill) || bill <= 0){ 
        alert('Define una ubicaci√≥n v√°lida y factura mayor a 0'); 
        return; 
      }

      // Mostrar "Calculando..."
      document.getElementById('textOutput').textContent = 'Calculando...';
      document.getElementById('calculandoText').style.display = 'block';
      document.getElementById('diagramContent').style.display = 'none';
      document.getElementById('cashflowChart').style.display = 'none';

      /* ====== CONSTANTS ====== */
      const PRICE_KWH       = 890;
      const USD_COP         = 4000;
      const USD_W_INSTALLED = 0.9;
      const PANEL_W         = 450;
      const TARGET          = 0.7;

      try {
        /* 1) Monthly kWh from bill */
        const kwhMonth = bill / PRICE_KWH;
        const kwh70    = kwhMonth * TARGET;

        /* 2) Specific yield (kWh/kWp/year) */
        let specific = 1350; // Valor por defecto
        
        try {
          const response = await fetch(
            `https://developer.nrel.gov/api/pvwatts/v8.json?api_key=ECmQDDWbYsWgQ4pFg2zFUZdlbTirJhA1pnfQRRC4&lat=${lat}&lon=${lon}&system_capacity=1&azimuth=180&tilt=${Math.abs(lat)}&array_type=1&losses=14&timeframe=monthly`
          );
          
          if (response.ok) {
            const pvw = await response.json();
            if(pvw && pvw.outputs && pvw.outputs.ac_annual) {
              specific = pvw.outputs.ac_annual;
            }
          }
        } catch(error) {
          console.warn('Error PVWatts, usando valor por defecto:', error);
        }

        /* 3) kWp required */
        const kwp     = (kwh70 * 12) / specific;
        const panels  = Math.ceil(kwp / (PANEL_W/1000));
        const kwpReal = panels * (PANEL_W/1000);

        /* 4) Price */
        const priceUsd = kwpReal * 1000 * USD_W_INSTALLED;
        const priceCop = priceUsd * USD_COP;

        /* 5) Simple pay-back con validaci√≥n */
        const ahorroAnualCop = bill * 12 * TARGET;
        const payback = ahorroAnualCop > 0 ? priceCop / ahorroAnualCop : 0;

        /* 6) C√ÅLCULO NUEVA FACTURA */
        const monthlyGrid = Math.max(0, kwhMonth - kwh70);
        const nuevaFactura = monthlyGrid * PRICE_KWH;
        const ahorroMensual = bill - nuevaFactura;

        /* 7) Build pretty output */
        const out =
          `üí° Consumo mensual: ${kwhMonth.toLocaleString()} kWh\n` +
          `‚òÄÔ∏è  Objetivo solar (70 %): ${kwh70.toLocaleString()} kWh\n` +
          `üîß Potencia de paneles: ${kwpReal.toFixed(2)} kWp  (${panels} paneles de ${PANEL_W} W)\n` +
          `üí∞ Precio aproximado: COP ${priceCop.toLocaleString()}\n` +
          `‚è±Ô∏è  Pay-back simple: ${payback.toFixed(1)} a√±os\n` +
          `üíµ Factura actual: $${bill.toLocaleString()} COP\n` +
          `üíö Nueva factura: $${nuevaFactura.toLocaleString()} COP\n` +
          `üí∞ Ahorro mensual: $${ahorroMensual.toLocaleString()} COP`;

        document.getElementById('textOutput').textContent = out;

        /* 8) Mostrar diagramas */
        document.getElementById('calculandoText').style.display = 'none';
        document.getElementById('diagramContent').style.display = 'block';

        /* 9) Actualizar textos overlay */
        const monthlySolar = kwh70;
        const monthlyHome = kwhMonth;

        document.getElementById('txtSolar').textContent = monthlySolar.toLocaleString() + ' kWh/mes';
        document.getElementById('txtGrid').textContent  = monthlyGrid.toLocaleString()  + ' kWh/mes';
        document.getElementById('txtHome').textContent  = monthlyHome.toLocaleString()  + ' kWh/mes';
        
        /* 10) Actualizar valores de factura */
        document.getElementById('txtFacturaAntigua').textContent = '$' + bill.toLocaleString() + ' COP';
        document.getElementById('txtFacturaNueva').textContent = '$' + nuevaFactura.toLocaleString() + ' COP';
        
        /* 11) Actualizar barras */
        const dailySolar = monthlySolar / 30.4;
        const dailyGrid = monthlyGrid / 30.4;
        const dailyHome = monthlyHome / 30.4;
        const maxBar = Math.max(dailySolar, dailyGrid, dailyHome, 1);

        document.getElementById('barSolar').style.width = `${(dailySolar / maxBar * 70).toFixed(0)}%`;
        document.getElementById('labSolar').textContent = `${dailySolar.toFixed(2)} kWh/d√≠a`;
        document.getElementById('barGrid').style.width  = `${(dailyGrid  / maxBar * 70).toFixed(0)}%`;
        document.getElementById('labGrid').textContent  = `${dailyGrid.toFixed(2)}  kWh/d√≠a`;
        document.getElementById('barHome').style.width  = `${(dailyHome  / maxBar * 70).toFixed(0)}%`;
        document.getElementById('labHome').textContent  = `${dailyHome.toFixed(2)}  kWh/d√≠a`;

        /* 12) CREAR GR√ÅFICA DE L√çNEA */
        if(priceCop > 0 && ahorroMensual > 0 && !isNaN(payback)) {
          crearGraficaLinea(priceCop, ahorroMensual, payback);
        }

      } catch (error) {
        console.error('Error en cotizaci√≥n:', error);
        document.getElementById('textOutput').textContent = 'Error en el c√°lculo. Verifica los datos.';
        document.getElementById('calculandoText').style.display = 'none';
        document.getElementById('diagramContent').style.display = 'block';
      }
    }

    // Inicializar barras a 0
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('barSolar').style.width = '0%';
      document.getElementById('barGrid').style.width = '0%';
      document.getElementById('barHome').style.width = '0%';
    });
  </script>

  <!-- Carga de Google Maps con tu clave real -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=GOOGLE_API_KEY_AQUI&libraries=places&callback=initMap">
  </script>
</body>
</html>

